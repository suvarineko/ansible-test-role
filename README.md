# ansible-test-role

## Совместимость
Роль протестирована на версии ansible **core 2.15.8**, но должна также работать на любой версии **core** выше 2.10.

## Быстрый старт
1. Устанавливаем зависимости
```shell
ansible-galaxy install -r requirements.yaml
```

2. Подготавливаем [инвентори-файл](./inventories/inventory.yaml). Если необходимо, то в [плейбуке](./prepare-vm.yaml) в параметре **hosts** меняем значение на нужную группу хостов или же указываем все хосты (значение **all**).

3. Запускаем роль указывая через флаг **-t** один, несколько или все теги (через запятую): encryption, cpu_perf, network, cpu_info.
```shell
ansible-playbook -i inventories/inventory.yaml -t <теги> prepare-vm.yaml
```

## Параметры в инвентори
|Параметр|Значение|
|--------|--------|
|network.rename_to|Новое имя для перименования активного сетевого интерфейса|
|disk.encrypt|Имя диска для шифрования, например - /dev/xvdf|
|disk.encrypt_type|Тип шифрования: luks1 или luks2|

## Плейбуки
### cpu_info.yaml
_Тег для запуска: cpu_info_
Выводит информацию о модели ЦПУ, количестве сокетов, ядер и статусе мулти-поточности.

### cpu_tuning.yaml
_Тег для запуска: cpu_perf_
1. Отключает C-state для ЦПУ выставляя параметры **intel_idle.max_cstate** и **processor.max_cstate** в значение **0** в переменной **GRUB_CMDLINE_LINUX_DEFAULT** файла **/etc/default/grub**, перед этим проверяя их текущие значения.
2. Переводит режим работы всех ЦПУ в **performance**, проверяя сначала есть ли активный драйвер cpufreq и загружен ли необходимый модуль ядра.

### network.yaml
_Тег для запуска: network_
Перманентно переименовывает активный сетевой интерфейс редактируя файл конфигурации netplan, заранее делает его бекап и автоматические восстанавливает в случае ошибок. Новое имя задаётся через переменную **network.rename_to** (например в инвентори).

### encryption.yaml
_Тег для запуска: encryption_
1. Шифрует диск заданный через переменную **disk.encrypt**. 
2. Находит следующий раздел после корневого ("/") и шифрует его.
В обоих случаях сначала производятся проверки что диск/раздел уже зашифрованы или диск уже содержит другой тип раздела, а значит должен быть сначала очищен. 
Тип шифрования можно задать через переменную **disk.encrypt_type**, возможные значения: **luks1** или **luks2**. Необходимо учитывать что оба типа имеют ограничения на минимальный размер раздела **16MiB** для luks2 и **2MiB** для luks1 и в случае несоответствия им в процессе будет выведена ошибка.

## Обработка ошибок
В каждом плейбуке присутствует обработка ошибок, в случае её возникновения неблокирующие блоки тасок будут пропущены, а выполнение других плейбуков роли будет продолжено.
